{% extends 'base.html' %}
{% load inventario_tags %}

{% block title %}Entrada de Stock - Sistema de Inventario{% endblock %}

{% block content %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12 text-center py-5">
            {% if busqueda or categoria_seleccionada or area_seleccionada %}
                <div class="display-1 mb-4 text-muted"></div>
                <h4>No se encontraron productos</h4>
                <p class="text-muted mb-4">Intenta cambiar los filtros de b煤squeda</p>
                <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                    <i class="bi bi-x-circle me-2"></i>
                    Limpiar Filtros
                </button>
            {% else %}
                <div class="display-1 mb-4 text-muted"></div>
                <h4>No hay productos disponibles</h4>
                <p class="text-muted mb-4">Primero debes crear algunos productos</p>
                <a href="{% url 'inventario:agregar_producto' %}" class="btn btn-success">
                    <i class="bi bi-plus-circle me-2"></i>
                    Crear Primer Producto
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Formulario de entrada de stock (oculto inicialmente) -->
    <div id="formularioEntrada" class="row" style="display: none;">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-plus-circle me-2"></i>
                        Agregar Stock a: <span id="productoSeleccionadoNombre"></span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Notificaci贸n de auto-completado -->
                    <div id="infoAutocompletado" class="alert alert-info d-none mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-lightbulb me-2"></i>
                            <div>
                                <small class="fw-bold">Datos auto-completados desde historial</small>
                                <div class="small">Los campos se llenaron autom谩ticamente basados en la 煤ltima compra de este producto. Puedes modificarlos si es necesario.</div>
                            </div>
                        </div>
                    </div>
                    
                    <form method="post" enctype="multipart/form-data" id="entradaStockForm">
                        {% csrf_token %}
                        <input type="hidden" id="producto_seleccionado" name="producto_id" value="">
                        
                        <div class="row">
                            <!-- Informaci贸n de la compra -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">Informaci贸n de tu compra</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-receipt me-1"></i>N煤mero de Boleta/Factura (opcional)
                                        <span class="badge bg-info ms-2">Auto-generado</span>
                                    </label>
                                    <input type="text" name="numero_entrada" id="numero_entrada" class="form-control" 
                                           value="{{ proximo_numero_entrada }}" 
                                           placeholder="Ej: 001234, F-5678">
                                    <div class="form-text">Opcional. Se genera autom谩ticamente, puedes cambiarlo o dejarlo en blanco.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-calendar3 me-1"></i>Fecha de Compra
                                    </label>
                                    <input type="date" name="fecha_compra" class="form-control" 
                                           value="{{ fecha_hoy }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-shop me-1"></i>Proveedor
                                    </label>
                                    <div class="d-flex align-items-center gap-2">
                                        <select id="entradaProveedorSelect" name="proveedor" class="form-select">
                                            <option value="">-- Seleccionar proveedor (opcional) --</option>
                                            {% for proveedor in proveedores %}
                                                <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openManageModal('proveedor')">
                                            <i class="bi bi-tools me-1"></i>Gestionar
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-currency-dollar me-1"></i>Total de la Compra
                                    </label>
                                    <input type="number" name="total_compra" class="form-control" 
                                           min="0" step="0.01" placeholder="0.00">
                                    <div class="form-text">Opcional: Solo para tus registros</div>
                                </div>
                            </div>
                            
                            <!-- Detalles del stock -->
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3">Detalles del stock</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-geo-alt me-1"></i>驴D贸nde lo guardaste?
                                    </label>
                                    <select id="entradaAreaSelect" name="area_destino" class="form-select" required>
                                        <option value="">-- Seleccionar 谩rea --</option>
                                        {% for area in areas %}
                                            <option value="{{ area.id }}">{{ area.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-123 me-1"></i>驴Cu谩nto compraste?
                                    </label>
                                    <div class="input-group">
                                        <input type="number" name="cantidad" class="form-control" 
                                               min="0.01" step="0.01" placeholder="0.00" required>
                                        <span class="input-group-text" id="unidadMedida">UN</span>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-currency-dollar me-1"></i>Precio por unidad
                                    </label>
                                    <input type="number" name="precio_unitario" class="form-control" 
                                           min="0" step="0.01" placeholder="0.00">
                                    <div class="form-text">Opcional: Para calcular costos</div>
                                </div>
                                
                                <!-- Foto de boleta -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-camera me-1"></i>Foto de Boleta/Factura
                                    </label>
                                    <input type="file" name="comprobante" class="form-control" accept="image/*">
                                    <div class="form-text">Opcional: Sube una foto del comprobante</div>
                                </div>
                                
                                <!-- Preview de imagen -->
                                <div id="imagePreview" class="text-center" style="display: none;">
                                    <img id="preview" src="" alt="Preview" class="img-fluid rounded shadow" style="max-height: 150px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Observaciones -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-chat-text me-1"></i>Observaciones
                                    </label>
                                    <textarea name="observaciones" class="form-control" rows="2" 
                                              placeholder="Notas adicionales sobre esta compra..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="cancelarSeleccion()">
                                        <i class="bi bi-x-circle me-2"></i>
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Agregar Stock
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.producto-seleccionable {
    cursor: pointer;
    transition: all 0.2s ease;
}

.producto-seleccionable:hover {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
}

.producto-seleccionado {
    background-color: #e7f3ff;
    border-left: 4px solid #0d6efd;
}
</style>

<script>
// Funci贸n para limpiar filtros
function limpiarFiltros() {
    document.querySelector('input[name="q"]').value = '';
    document.querySelector('select[name="categoria"]').value = '';
    document.querySelector('select[name="area"]').value = '';
    document.getElementById('buscarProductoForm').submit();
}

// Funci贸n para seleccionar producto
function seleccionarProducto(elemento) {
    // Limpiar selecci贸n anterior
    document.querySelectorAll('.producto-seleccionable').forEach(el => {
        el.classList.remove('producto-seleccionado');
    });
    
    // Marcar como seleccionado
    elemento.classList.add('producto-seleccionado');
    
    // Obtener datos del producto
    const productoId = elemento.dataset.productoId;
    const productoNombre = elemento.dataset.productoNombre;
    const productoCodigo = elemento.dataset.productoCodigo;
    const productoUnidad = elemento.dataset.productoUnidad;
    
    // Obtener datos del historial
    const ultimoProveedorId = elemento.dataset.ultimoProveedorId;
    const ultimoProveedorNombre = elemento.dataset.ultimoProveedorNombre;
    const ultimaAreaId = elemento.dataset.ultimaAreaId;
    const ultimoPrecio = elemento.dataset.ultimoPrecio;
    const ultimaCantidad = elemento.dataset.ultimaCantidad;
    
    // Llenar formulario b谩sico
    document.getElementById('producto_seleccionado').value = productoId;
    document.getElementById('productoSeleccionadoNombre').textContent = productoNombre + ' (' + productoCodigo + ')';
    document.getElementById('unidadMedida').textContent = productoUnidad;
    
    // Auto-completar con datos del historial
    let autocompletado = false;
    
    if (ultimoProveedorId) {
        const proveedorSelect = document.querySelector('select[name="proveedor"]');
        proveedorSelect.value = ultimoProveedorId;
        mostrarNotificacionAutocompletado('Proveedor', ultimoProveedorNombre);
        autocompletado = true;
    }
    
    if (ultimaAreaId) {
        const areaSelect = document.querySelector('select[name="area_destino"]');
        areaSelect.value = ultimaAreaId;
        
        // Obtener nombre del area del select
        const areaOption = areaSelect.querySelector(`option[value="${ultimaAreaId}"]`);
        if (areaOption) {
            mostrarNotificacionAutocompletado('rea de destino', areaOption.textContent);
        }
        autocompletado = true;
    }
    
    if (ultimoPrecio) {
        const precioInput = document.querySelector('input[name="precio_unitario"]');
        precioInput.value = ultimoPrecio;
        mostrarNotificacionAutocompletado('Precio unitario', `$${parseFloat(ultimoPrecio).toLocaleString()}`);
        autocompletado = true;
    }
    
    if (ultimaCantidad) {
        const cantidadInput = document.querySelector('input[name="cantidad"]');
        cantidadInput.value = ultimaCantidad;
        mostrarNotificacionAutocompletado('Cantidad sugerida', `${ultimaCantidad} ${productoUnidad}`);
        autocompletado = true;
    }
    
    // Mostrar notificaci贸n general si hubo auto-completado
    if (autocompletado) {
        document.getElementById('infoAutocompletado').classList.remove('d-none');
    }
    
    // Mostrar formulario
    document.getElementById('formularioEntrada').style.display = 'block';
    
    // Scroll hacia el formulario
    document.getElementById('formularioEntrada').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
}

// Funci贸n para mostrar notificaciones de auto-completado
function mostrarNotificacionAutocompletado(campo, valor) {
    // Crear elemento de notificaci贸n temporal
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        <small>
            <i class="bi bi-magic me-1"></i>
            <strong>${campo}</strong> auto-completado: ${valor}
        </small>
        <button type="button" class="btn-close btn-close-sm" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remover despu茅s de 3 segundos
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 3000);
}

// Funci贸n para cancelar selecci贸n
function cancelarSeleccion() {
    document.querySelectorAll('.producto-seleccionable').forEach(el => {
        el.classList.remove('producto-seleccionado');
    });
    document.getElementById('formularioEntrada').style.display = 'none';
    document.getElementById('entradaStockForm').reset();
    document.getElementById('infoAutocompletado').classList.add('d-none');
    
    // Remover notificaciones flotantes
    document.querySelectorAll('.alert.position-fixed').forEach(el => {
        el.remove();
    });
}

// Auto-submit para selects
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('#buscarProductoForm select');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            document.getElementById('buscarProductoForm').submit();
        });
    });
    
    // Preview de imagen
    const fileInput = document.querySelector('input[name="comprobante"]');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }
        });
    }
});

function ensureJson(response) {
    if (!response.ok) {
        return response.text().then(text => { throw new Error(text || `Error ${response.status}`); });
    }
    const contentType = response.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) {
        return response.text().then(text => { throw new Error('Respuesta inesperada del servidor: ' + text); });
    }
    return response.json();
}

function postJson(url, body) {
    return fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(body)
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% include 'inventario/includes/manage_entities_modal.html' with modal_id='manageEntitiesModal' proveedor_select_id='entradaProveedorSelect' area_select_id='entradaAreaSelect' show_area_tab=True area_tipos=area_tipos %}
{% endblock %}