{% extends 'base.html' %}
{% load inventario_tags %}

{% block title %}Productos - Sistema de Inventario{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold mb-2">
                        <i class="bi bi-boxes me-3 text-primary"></i>
                        Mis Productos
                    </h1>
                    <p class="text-muted mb-0">Gestiona el inventario de tu hotel</p>
                </div>
                <div class="d-flex gap-2">
                    <!-- Ayuda r√°pida -->
                    <a href="{% url 'inventario:ayuda' %}" class="btn btn-info me-2">
                        <i class="bi bi-question-circle me-2"></i>
                        Ayuda
                    </a>
                    
                    <!-- Gu√≠a simple de qu√© bot√≥n usar -->
                    <div class="dropdown">
                        <button class="btn btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-lightbulb me-2"></i>
                            ¬øQu√© bot√≥n usar?
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="min-width: 350px;">
                            <li class="dropdown-header">
                                <strong>ü§î ¬øNo sabes qu√© bot√≥n usar?</strong>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="px-3 py-2">
                                <div class="d-flex align-items-start">
                                    <div class="badge bg-success me-3 mt-1">NUEVO</div>
                                    <div>
                                        <strong>üÜï Nuevo Producto</strong><br>
                                        <small class="text-muted">
                                            ‚Ä¢ Es la primera vez que compras este producto<br>
                                            ‚Ä¢ No existe en tu inventario<br>
                                            ‚Ä¢ Ejemplo: Compraste shampoo por primera vez
                                        </small>
                                    </div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="px-3 py-2">
                                <div class="d-flex align-items-start">
                                    <div class="badge bg-warning me-3 mt-1">M√ÅS</div>
                                    <div>
                                        <strong>üì• Entrada de Stock</strong><br>
                                        <small class="text-muted">
                                            ‚Ä¢ Ya tienes este producto<br>
                                            ‚Ä¢ Compraste m√°s cantidad<br>
                                            ‚Ä¢ Ejemplo: Compraste m√°s shampoo para reabastecer
                                        </small>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <a href="{% url 'inventario:agregar_producto' %}" class="btn btn-success">
                        <i class="bi bi-plus-circle me-2"></i>
                        üÜï Nuevo Producto
                    </a>
                    
                    <a href="{% url 'inventario:entrada_stock' %}" class="btn btn-warning">
                        <i class="bi bi-box-arrow-in-down me-2"></i>
                        üì• Entrada de Stock
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y Buscador -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>
                        Filtros y B√∫squeda
                    </h6>
                </div>
                <div class="card-body">
                    <form method="get" id="filtroForm">
                        <div class="row g-3">
                            <!-- Buscador -->
                            <div class="col-md-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-search me-1"></i>Buscar producto
                                </label>
                                <input type="text" name="q" class="form-control" 
                                       placeholder="Nombre o c√≥digo del producto..." 
                                       value="{{ busqueda|default:'' }}">
                            </div>
                            
                            <!-- Filtro por categor√≠a -->
                            <div class="col-md-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-tag me-1"></i>Categor√≠a
                                </label>
                                <select name="categoria" class="form-select">
                                    <option value="">Todas las categor√≠as</option>
                                    {% for categoria in categorias %}
                                        <option value="{{ categoria.id }}" 
                                                {% if categoria_seleccionada == categoria.id %}selected{% endif %}>
                                            {{ categoria.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Filtro por √°rea -->
                            <div class="col-md-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-geo-alt me-1"></i>√Årea
                                </label>
                                <select name="area" class="form-select">
                                    <option value="">Todas las √°reas</option>
                                    {% for area in areas %}
                                        <option value="{{ area.id }}" 
                                                {% if area_seleccionada == area.id %}selected{% endif %}>
                                            {{ area.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Filtro por stock -->
                            <div class="col-md-2">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-bar-chart me-1"></i>Stock
                                </label>
                                <select name="stock" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="bajo" {% if stock_filtro == 'bajo' %}selected{% endif %}>Stock bajo</option>
                                    <option value="agotado" {% if stock_filtro == 'agotado' %}selected{% endif %}>Agotados</option>
                                    <option value="disponible" {% if stock_filtro == 'disponible' %}selected{% endif %}>Con stock</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="bi bi-search me-1"></i>Buscar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                                    <i class="bi bi-x-circle me-1"></i>Limpiar
                                </button>
                                
                                <!-- Resumen de filtros aplicados -->
                                <div class="d-inline-block ms-3">
                                    {% if busqueda or categoria_seleccionada or area_seleccionada or stock_filtro %}
                                        <small class="text-muted">
                                            <i class="bi bi-filter me-1"></i>
                                            Filtros aplicados:
                                            {% if busqueda %}
                                                <span class="badge bg-info me-1">B√∫squeda: "{{ busqueda }}"</span>
                                            {% endif %}
                                            {% if categoria_seleccionada %}
                                                <span class="badge bg-primary me-1">
                                                    {% for cat in categorias %}
                                                        {% if cat.id == categoria_seleccionada %}{{ cat.nombre }}{% endif %}
                                                    {% endfor %}
                                                </span>
                                            {% endif %}
                                            {% if area_seleccionada %}
                                                <span class="badge bg-success me-1">
                                                    {% for area in areas %}
                                                        {% if area.id == area_seleccionada %}{{ area.nombre }}{% endif %}
                                                    {% endfor %}
                                                </span>
                                            {% endif %}
                                            {% if stock_filtro %}
                                                <span class="badge bg-warning me-1">{{ stock_filtro|capfirst }}</span>
                                            {% endif %}
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ejemplo visual (colapsable) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="accordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ejemploVisual">
                            <i class="bi bi-lightbulb me-2"></i>
                            üí° ¬øNo sabes qu√© bot√≥n usar? Ver ejemplos
                        </button>
                    </h2>
                    <div id="ejemploVisual" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="row text-center">
                                <div class="col-md-6">
                                    <div class="card h-100 border-success">
                                        <div class="card-body">
                                            <div class="display-1 mb-3">üÜï</div>
                                            <h5 class="text-success">Nuevo Producto</h5>
                                            <p class="text-muted small">
                                                Usa este bot√≥n cuando sea la <strong>primera vez</strong> que compras algo
                                            </p>
                                            <div class="text-start small">
                                                <strong>Ejemplo:</strong><br>
                                                "Compr√© shampoo coreano por primera vez"<br>
                                                "Necesito agregar este producto nuevo a mi inventario"
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100 border-warning">
                                        <div class="card-body">
                                            <div class="display-1 mb-3">üì•</div>
                                            <h5 class="text-warning">Entrada de Stock</h5>
                                            <p class="text-muted small">
                                                Usa este bot√≥n cuando ya tienes el producto y compraste <strong>m√°s cantidad</strong>
                                            </p>
                                            <div class="text-start small">
                                                <strong>Ejemplo:</strong><br>
                                                "Ya tengo shampoo coreano, pero compr√© m√°s"<br>
                                                "Quiero agregar las 5 unidades que compr√© hoy"
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados de la b√∫squeda -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-boxes me-2"></i>
                    Productos encontrados
                    <span class="badge bg-secondary">{{ total_productos }}</span>
                    {% if page_obj.paginator.num_pages > 1 %}
                        <small class="text-muted ms-2">
                            (p√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }})
                        </small>
                    {% endif %}
                </h5>
                
                <!-- Ordenamiento -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-sort-down me-1"></i>Ordenar por
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url_with_params orden='nombre' %}">
                            <i class="bi bi-sort-alpha-down me-2"></i>Nombre A-Z
                        </a></li>
                        <li><a class="dropdown-item" href="{% url_with_params orden='-nombre' %}">
                            <i class="bi bi-sort-alpha-up me-2"></i>Nombre Z-A
                        </a></li>
                        <li><a class="dropdown-item" href="{% url_with_params orden='categoria__nombre' %}">
                            <i class="bi bi-tag me-2"></i>Categor√≠a
                        </a></li>
                        <li><a class="dropdown-item" href="{% url_with_params orden='codigo' %}">
                            <i class="bi bi-upc me-2"></i>C√≥digo
                        </a></li>
                        <li><a class="dropdown-item" href="{% url_with_params orden='-fecha_creacion' %}">
                            <i class="bi bi-clock me-2"></i>M√°s recientes
                        </a></li>
                        <li><a class="dropdown-item" href="{% url_with_params orden='stock_total' %}">
                            <i class="bi bi-bar-chart me-2"></i>Menos stock
                        </a></li>
                        <li><a class="dropdown-item" href="{% url_with_params orden='-stock_total' %}">
                            <i class="bi bi-bar-chart-fill me-2"></i>M√°s stock
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de productos -->
    {% if productos %}
    <div class="row">
        {% for producto in productos %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card product-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">{{ producto.nombre }}</h6>
                            <small class="text-muted">
                                <i class="bi bi-upc me-1"></i>{{ producto.codigo }}
                            </small>
                        </div>
                        <span class="badge bg-primary">{{ producto.categoria.nombre }}</span>
                    </div>
                    
                    <!-- Stock info -->
                    <div class="mb-3">
                        {% with stock_total=producto.stock_total %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Stock Total:</small>
                            <strong class="{% if stock_total <= producto.stock_minimo %}text-warning{% elif stock_total == 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ stock_total|default:"0" }} {{ producto.unidad_medida }}
                            </strong>
                        </div>
                        
                        <!-- Indicador de stock -->
                        {% if stock_total == 0 %}
                            <div class="alert alert-danger py-1 px-2 mb-2">
                                <small><i class="bi bi-exclamation-triangle me-1"></i>Sin stock</small>
                            </div>
                        {% elif stock_total <= producto.stock_minimo %}
                            <div class="alert alert-warning py-1 px-2 mb-2">
                                <small><i class="bi bi-exclamation-circle me-1"></i>Stock bajo</small>
                            </div>
                        {% endif %}
                        
                        <!-- √Åreas donde est√° -->
                        {% if producto.areas_con_stock %}
                            <small class="text-muted">
                                <i class="bi bi-geo-alt me-1"></i>
                                En: 
                                {% for area in producto.areas_con_stock %}
                                    <span class="badge bg-light text-dark">{{ area.area__nombre }}</span>
                                {% endfor %}
                            </small>
                        {% endif %}
                        {% endwith %}
                    </div>
                    
                    <!-- Precio -->
                    {% if producto.precio_unitario %}
                    <div class="mb-3">
                        <small class="text-muted">Precio referencial:</small>
                        <strong class="text-success">{{ producto.precio_unitario|format_currency }}</strong>
                    </div>
                    {% endif %}
                    
                    <!-- Botones de acci√≥n -->
                    <div class="d-flex gap-1">
                        <button type="button" class="btn btn-outline-info btn-sm" 
                                data-bs-toggle="modal" data-bs-target="#modalProducto{{ producto.id }}"
                                data-bs-toggle="tooltip" title="Vista r√°pida">
                            <i class="bi bi-eye-fill"></i>
                        </button>
                        <a href="{% url 'inventario:detalle_producto' producto.id %}" 
                           class="btn btn-outline-primary btn-sm flex-fill"
                           data-bs-toggle="tooltip" title="Ver detalles completos">
                            <i class="bi bi-clipboard-data me-1"></i>Detalles
                        </a>
                        <a href="{% url 'inventario:entrada_stock' %}?producto={{ producto.id }}" 
                           class="btn btn-warning btn-sm"
                           data-bs-toggle="tooltip" title="Agregar m√°s stock">
                            <i class="bi bi-plus-lg me-1"></i>Stock
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Paginaci√≥n -->
    {% if page_obj.paginator.num_pages > 1 %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Paginaci√≥n de productos">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="{% url_with_params page=1 %}">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="{% url_with_params page=page_obj.previous_page_number %}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="{% url_with_params page=num %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{% url_with_params page=page_obj.next_page_number %}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="{% url_with_params page=page_obj.paginator.num_pages %}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <div class="row">
        <div class="col-12 text-center py-5">
            {% if busqueda or categoria_seleccionada or area_seleccionada or stock_filtro %}
                <div class="display-1 mb-4">üîç</div>
                <h3>No se encontraron productos</h3>
                <p class="text-muted mb-4">Intenta cambiar los filtros de b√∫squeda</p>
                <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                    <i class="bi bi-x-circle me-2"></i>
                    Limpiar Filtros
                </button>
            {% else %}
                <div class="display-1 mb-4">üì¶</div>
                <h3>No tienes productos a√∫n</h3>
                <p class="text-muted mb-4">Comienza agregando tu primer producto</p>
                <a href="{% url 'inventario:agregar_producto' %}" class="btn btn-success btn-lg">
                    <i class="bi bi-plus-circle me-2"></i>
                    Agregar mi Primer Producto
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modales de vista r√°pida -->
{% for producto in productos %}
<div class="modal fade" id="modalProducto{{ producto.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-box me-2"></i>
                    {{ producto.nombre }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Informaci√≥n General</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>C√≥digo:</strong></td>
                                <td>{{ producto.codigo }}</td>
                            </tr>
                            <tr>
                                <td><strong>Categor√≠a:</strong></td>
                                <td><span class="badge bg-primary">{{ producto.categoria.nombre }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Unidad:</strong></td>
                                <td>{{ producto.unidad_medida }}</td>
                            </tr>
                            {% if producto.precio_unitario %}
                            <tr>
                                <td><strong>Precio:</strong></td>
                                <td class="text-success fw-bold">{{ producto.precio_unitario|format_currency }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td><strong>Stock m√≠nimo:</strong></td>
                                <td>{{ producto.stock_minimo }} {{ producto.unidad_medida }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">Stock por √Årea</h6>
                        {% if producto.areas_con_stock %}
                            <div class="list-group list-group-flush">
                                {% for area in producto.areas_con_stock %}
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <small>{{ area.area__nombre }}</small>
                                    <span class="badge bg-success">{{ area.cantidad }} {{ producto.unidad_medida }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>Total:</strong>
                                <strong class="text-primary">{{ producto.stock_total|default:"0" }} {{ producto.unidad_medida }}</strong>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                No hay stock disponible
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                {% if producto.descripcion %}
                <hr>
                <h6 class="text-secondary">Descripci√≥n</h6>
                <p class="text-muted">{{ producto.descripcion }}</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a href="{% url 'inventario:detalle_producto' producto.id %}" class="btn btn-primary">
                    <i class="bi bi-clipboard-data me-1"></i>Ver Detalles Completos
                </a>
                <a href="{% url 'inventario:entrada_stock' %}?producto={{ producto.id }}" class="btn btn-warning">
                    <i class="bi bi-plus-lg me-1"></i>Agregar Stock
                </a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<style>
.product-card {
    transition: transform 0.2s ease-in-out;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75em;
}

.alert {
    font-size: 0.875em;
}
</style>

<script>
// Funci√≥n para limpiar filtros
function limpiarFiltros() {
    // Limpiar todos los campos del formulario
    document.querySelector('input[name="q"]').value = '';
    document.querySelector('select[name="categoria"]').value = '';
    document.querySelector('select[name="area"]').value = '';
    document.querySelector('select[name="stock"]').value = '';
    
    // Enviar formulario vac√≠o
    document.getElementById('filtroForm').submit();
}

// B√∫squeda en tiempo real (opcional)
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="q"]');
    let searchTimeout;
    
    // B√∫squeda con debounce
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (this.value.length >= 3 || this.value.length === 0) {
                // Auto-submit solo si hay 3+ caracteres o est√° vac√≠o
                // document.getElementById('filtroForm').submit();
            }
        }, 500);
    });
    
    // Submit autom√°tico al cambiar selects
    const selects = document.querySelectorAll('#filtroForm select');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            document.getElementById('filtroForm').submit();
        });
    });
    
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Funci√≥n para resaltar texto de b√∫squeda
function resaltarBusqueda() {
    const busqueda = '{{ busqueda|escapejs }}';
    if (busqueda) {
        const productos = document.querySelectorAll('.card-title, .text-muted');
        productos.forEach(el => {
            const texto = el.innerHTML;
            const regex = new RegExp(`(${busqueda})`, 'gi');
            el.innerHTML = texto.replace(regex, '<mark>$1</mark>');
        });
    }
}

// Ejecutar despu√©s de cargar la p√°gina
document.addEventListener('DOMContentLoaded', resaltarBusqueda);
</script>
{% endblock %}