{% extends 'base.html' %}
{% load inventario_tags %}

{% block title %}Productos - Sistema de Inventario{% endblock %}

{% block content %}
<div class="container-fluid px-4 productos-page">
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-4">
        <div>
            <h1 class="display-6 fw-bold mb-2">
                <i class="bi bi-boxes me-3 text-primary"></i>
                Mis Productos
            </h1>
            <p class="text-muted mb-0">{{ total_productos }} productos activos en el inventario</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <a href="{% url 'inventario:agregar_producto' %}" class="btn btn-success">
                <i class="bi bi-plus-circle me-2"></i>
                Nuevo producto
            </a>
            <a href="{% url 'inventario:ingresar_factura' %}" class="btn btn-outline-warning">
                <i class="bi bi-receipt me-2"></i>
                Ingresar factura
            </a>
            <a href="{% url 'inventario:ayuda' %}" class="btn btn-outline-info">
                <i class="bi bi-question-circle me-2"></i>
                Guía de uso
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-9">
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3 align-items-end" id="formFiltros">
                        <div class="col-md-4">
                            <label class="form-label">Buscar</label>
                            <input type="text" name="q" value="{{ busqueda|default:'' }}" class="form-control" placeholder="Nombre, código o descripción">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Categoría</label>
                            <select name="categoria" class="form-select">
                                <option value="">Todas</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.id }}" {% if categoria_seleccionada == categoria.id %}selected{% endif %}>{{ categoria.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Área</label>
                            <select name="area" class="form-select">
                                <option value="">Todas</option>
                                {% for area in areas %}
                                <option value="{{ area.id }}" {% if area_seleccionada == area.id %}selected{% endif %}>{{ area.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-grid">
                            <button type="submit" class="btn btn-primary">Filtrar</button>
                        </div>
                        <div class="col-12 d-flex flex-wrap gap-2">
                            <div>
                                <label class="form-label mb-0">Estado de stock</label>
                                <select name="stock" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="disponible" {% if stock_filtro == 'disponible' %}selected{% endif %}>Con stock</option>
                                    <option value="bajo" {% if stock_filtro == 'bajo' %}selected{% endif %}>Stock bajo</option>
                                    <option value="agotado" {% if stock_filtro == 'agotado' %}selected{% endif %}>Sin stock</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label mb-0">Ordenar por</label>
                                <select name="orden" class="form-select">
                                    <option value="categoria__nombre" {% if orden_actual == 'categoria__nombre' %}selected{% endif %}>Categoría</option>
                                    <option value="nombre" {% if orden_actual == 'nombre' %}selected{% endif %}>Nombre (A-Z)</option>
                                    <option value="-nombre" {% if orden_actual == '-nombre' %}selected{% endif %}>Nombre (Z-A)</option>
                                    <option value="stock_total" {% if orden_actual == 'stock_total' %}selected{% endif %}>Stock ascendente</option>
                                    <option value="-stock_total" {% if orden_actual == '-stock_total' %}selected{% endif %}>Stock descendente</option>
                                    <option value="-fecha_creacion" {% if orden_actual == '-fecha_creacion' %}selected{% endif %}>Más recientes</option>
                                </select>
                            </div>
                            <div class="align-self-end">
                                <a href="{% url 'inventario:productos' %}" class="btn btn-light">Limpiar filtros</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% if productos %}
            <div class="row g-3" id="listaProductos">
                {% for producto in productos %}
                <div class="col-12 col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="card-title mb-1">{{ producto.nombre }}</h5>
                                    <small class="text-muted">Código: {{ producto.codigo }}</small>
                                </div>
                                {% if producto.categoria %}
                                <span class="badge bg-secondary">{{ producto.categoria.nombre }}</span>
                                {% endif %}
                            </div>

                            <p class="text-muted mb-3">Stock total: <strong>{{ producto.stock_total|default:0 }}</strong> {{ producto.unidad_medida }}</p>

                            {% if producto.stock_total|default:0 == 0 %}
                            <div class="alert alert-danger py-2 mb-3">
                                <i class="bi bi-exclamation-octagon me-2"></i>Sin stock disponible
                            </div>
                            {% elif producto.stock_total <= producto.stock_minimo %}
                            <div class="alert alert-warning py-2 mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>Stock bajo (mínimo {{ producto.stock_minimo }})
                            </div>
                            {% endif %}

                            {% if producto.areas_con_stock %}
                            <div class="mb-3">
                                <h6 class="fw-semibold mb-2">Stock por área</h6>
                                <ul class="list-unstyled mb-0 small">
                                    {% for item in producto.areas_con_stock %}
                                    <li class="d-flex justify-content-between">
                                        <span>{{ item.area__nombre }}</span>
                                        <span>{{ item.cantidad }} {{ producto.unidad_medida }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                            <div class="mt-auto d-flex gap-2">
                                <a class="btn btn-outline-primary w-100" href="{% url 'inventario:detalle_producto' producto.id %}">
                                    <i class="bi bi-eye me-1"></i> Ver detalle
                                </a>
                                <a class="btn btn-outline-secondary w-100" href="{% url 'inventario:entrada_stock' %}?producto={{ producto.id }}">
                                    <i class="bi bi-plus-circle me-1"></i> Agregar stock
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5 text-muted">
                    <i class="bi bi-inbox display-5 d-block mb-3"></i>
                    {% if busqueda or categoria_seleccionada or area_seleccionada or stock_filtro %}
                        No encontramos productos que coincidan con los filtros seleccionados.
                    {% else %}
                        Todavía no hay productos registrados. Crea tu primer producto para comenzar.
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if page_obj.has_other_pages %}
            <nav class="mt-4" aria-label="Paginación de productos">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if busqueda %}&q={{ busqueda }}{% endif %}{% if categoria_seleccionada %}&categoria={{ categoria_seleccionada }}{% endif %}{% if area_seleccionada %}&area={{ area_seleccionada }}{% endif %}{% if stock_filtro %}&stock={{ stock_filtro }}{% endif %}{% if orden_actual %}&orden={{ orden_actual }}{% endif %}">Primera</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if busqueda %}&q={{ busqueda }}{% endif %}{% if categoria_seleccionada %}&categoria={{ categoria_seleccionada }}{% endif %}{% if area_seleccionada %}&area={{ area_seleccionada }}{% endif %}{% if stock_filtro %}&stock={{ stock_filtro }}{% endif %}{% if orden_actual %}&orden={{ orden_actual }}{% endif %}">Anterior</a>
                    </li>
                    {% endif %}

                    <li class="page-item active"><span class="page-link">{{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if busqueda %}&q={{ busqueda }}{% endif %}{% if categoria_seleccionada %}&categoria={{ categoria_seleccionada }}{% endif %}{% if area_seleccionada %}&area={{ area_seleccionada }}{% endif %}{% if stock_filtro %}&stock={{ stock_filtro }}{% endif %}{% if orden_actual %}&orden={{ orden_actual }}{% endif %}">Siguiente</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if busqueda %}&q={{ busqueda }}{% endif %}{% if categoria_seleccionada %}&categoria={{ categoria_seleccionada }}{% endif %}{% if area_seleccionada %}&area={{ area_seleccionada }}{% endif %}{% if stock_filtro %}&stock={{ stock_filtro }}{% endif %}{% if orden_actual %}&orden={{ orden_actual }}{% endif %}">Última</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>

        <div class="col-12 col-lg-3">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-lightbulb me-2"></i>
                    ¿Cómo decido qué acción tomar?
                </div>
                <div class="card-body small">
                    <p class="mb-2"><strong>🆕 Nuevo producto</strong></p>
                    <p class="text-muted">Regístralo cuando nunca antes lo has comprado o aún no aparece en tu inventario.</p>
                    <hr>
                    <p class="mb-2"><strong>📥 Entrada de stock</strong></p>
                    <p class="text-muted">Úsala cuando repongas un producto ya existente o necesites mover unidades a un área específica.</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>
                    Tips rápidos
                </div>
                <div class="card-body small">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3">
                            <strong>Filtros combinados</strong><br>
                            Aplica búsqueda, categoría y área a la vez para localizar productos puntuales.
                        </li>
                        <li class="mb-3">
                            <strong>Orden dinámico</strong><br>
                            Cambia el orden para identificar rápidamente los productos con menos stock.
                        </li>
                        <li>
                            <strong>Detalle completo</strong><br>
                            Desde "Ver detalle" revisa movimientos, stock por área y alertas activas.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
