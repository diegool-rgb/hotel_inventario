{% extends 'base.html' %}

{% block title %}Agregar Stock F√°cil{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-primary">üè® Agregar Stock al Inventario</h2>
    
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i> <strong>Instrucciones:</strong> Busca el producto, selecci√≥nalo y completa los datos para agregar stock.
    </div>

    <!-- B√öSQUEDA -->
    <div class="card mb-4" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white;">
        <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-search"></i> Paso 1: Buscar Producto</h5>
            <div class="input-group">
                <input type="text" 
                       class="form-control form-control-lg" 
                       id="txtBusqueda" 
                       placeholder="Escribe el nombre del producto (ej: acondicionador, jab√≥n...)"
                       onkeyup="buscarProductos()"
                       autocomplete="off">
                <button class="btn btn-light btn-lg" type="button" onclick="buscarProductos()">
                    <i class="bi bi-search"></i> BUSCAR
                </button>
            </div>
            
            <div id="resultadosBusqueda" 
                 style="display: none; background: white; color: black; border-radius: 8px; margin-top: 15px; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            </div>
        </div>
    </div>

    <!-- PRODUCTO SELECCIONADO -->
    <div id="productoElegido" class="card mb-4" style="display: none; border-left: 5px solid #28a745;">
        <div class="card-body">
            <h5 class="text-success"><i class="bi bi-check-circle"></i> Paso 2: Producto Seleccionado</h5>
            <div id="datosProducto" class="mt-3"></div>
        </div>
    </div>

    <!-- FORMULARIO -->
    <div id="formularioCompleto" class="card" style="display: none;">
        <div class="card-body">
            <h5 class="text-primary mb-4"><i class="bi bi-pencil"></i> Paso 3: Completar Informaci√≥n</h5>
            
            <form method="post" onsubmit="return validarDatos()">
                {% csrf_token %}
                <input type="hidden" id="idProducto" name="producto_id">
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold text-primary">
                            <i class="bi bi-plus-circle"></i> Cantidad *
                        </label>
                        <input type="number" 
                               class="form-control form-control-lg" 
                               name="cantidad" 
                               id="inputCantidad" 
                               min="0.01" 
                               step="0.01" 
                               placeholder="Ejemplo: 10" 
                               required>
                        <small class="text-muted">¬øCu√°ntas unidades agregaste?</small>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold text-primary">
                            <i class="bi bi-geo-alt"></i> √Årea de Almacenamiento *
                        </label>
                        <select class="form-select form-control-lg" name="area" id="selectArea" required>
                            <option value="">Selecciona el √°rea</option>
                            {% for area in areas %}
                            <option value="{{ area.id }}">{{ area.nombre }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">¬øD√≥nde guardaste el producto?</small>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-building"></i> Proveedor
                        </label>
                        <select class="form-select form-control-lg" name="proveedor" id="selectProveedor">
                            <option value="">Sin proveedor espec√≠fico</option>
                            {% for proveedor in proveedores %}
                            <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Opcional</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-cash"></i> Precio Unitario
                        </label>
                        <input type="number" 
                               class="form-control form-control-lg" 
                               name="precio" 
                               id="inputPrecio" 
                               min="0" 
                               step="0.01" 
                               placeholder="0.00">
                        <small class="text-muted">¬øCu√°nto cost√≥ cada unidad? (Opcional)</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-calendar"></i> Fecha de Compra
                        </label>
                        <input type="date" 
                               class="form-control form-control-lg" 
                               name="fecha_compra" 
                               id="inputFecha" 
                               value="{{ fecha_hoy }}">
                        <small class="text-muted">¬øCu√°ndo compraste el producto?</small>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary btn-lg" onclick="limpiarTodo()">
                        <i class="bi bi-arrow-counterclockwise"></i> Limpiar Todo
                    </button>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle-fill"></i> AGREGAR STOCK
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Lista de productos disponibles
var listaProductos = [
    {% for producto in productos %}
    {
        id: {{ producto.id }},
        nombre: "{{ producto.nombre|escapejs }}",
        codigo: "{{ producto.codigo|escapejs }}",
        categoria: "{{ producto.categoria.nombre|escapejs }}",
        stock_actual: {{ producto.stock_total|default:0 }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

var productoActualSeleccionado = null;

// Funci√≥n principal de b√∫squeda
function buscarProductos() {
    var textoBusqueda = document.getElementById('txtBusqueda').value.toLowerCase().trim();
    var contenedorResultados = document.getElementById('resultadosBusqueda');
    
    // Si hay menos de 2 caracteres, ocultar resultados
    if (textoBusqueda.length < 2) {
        contenedorResultados.style.display = 'none';
        return;
    }
    
    // Buscar productos que coincidan
    var productosEncontrados = listaProductos.filter(function(producto) {
        return producto.nombre.toLowerCase().includes(textoBusqueda) || 
               producto.codigo.toLowerCase().includes(textoBusqueda) ||
               producto.categoria.toLowerCase().includes(textoBusqueda);
    });
    
    // Si no se encontraron productos
    if (productosEncontrados.length === 0) {
        contenedorResultados.innerHTML = '<div class="p-3 text-center text-muted"><i class="bi bi-exclamation-circle"></i><br>No se encontraron productos con ese nombre</div>';
        contenedorResultados.style.display = 'block';
        return;
    }
    
    // Construir HTML con los resultados
    var htmlResultados = '';
    for (var i = 0; i < Math.min(productosEncontrados.length, 8); i++) {
        var prod = productosEncontrados[i];
        htmlResultados += '<div class="p-3 border-bottom" style="cursor: pointer; transition: background 0.2s;" ';
        htmlResultados += 'onmouseover="this.style.background=\'#f8f9fa\'" ';
        htmlResultados += 'onmouseout="this.style.background=\'white\'" ';
        htmlResultados += 'onclick="seleccionarProducto(' + prod.id + ')">';
        htmlResultados += '<div class="fw-bold text-dark">' + prod.nombre + '</div>';
        htmlResultados += '<small class="text-muted">';
        htmlResultados += '<span class="badge bg-secondary me-2">' + prod.codigo + '</span>';
        htmlResultados += prod.categoria + ' | Stock actual: <strong>' + prod.stock_actual + '</strong> unidades';
        htmlResultados += '</small></div>';
    }
    
    contenedorResultados.innerHTML = htmlResultados;
    contenedorResultados.style.display = 'block';
}

// Funci√≥n para seleccionar un producto
function seleccionarProducto(idProducto) {
    // Buscar el producto en la lista
    productoActualSeleccionado = listaProductos.find(function(p) { 
        return p.id === idProducto; 
    });
    
    if (!productoActualSeleccionado) {
        alert('Error: No se pudo seleccionar el producto');
        return;
    }
    
    // Actualizar el campo de b√∫squeda
    document.getElementById('txtBusqueda').value = productoActualSeleccionado.nombre;
    
    // Ocultar resultados de b√∫squeda
    document.getElementById('resultadosBusqueda').style.display = 'none';
    
    // Mostrar informaci√≥n del producto seleccionado
    document.getElementById('datosProducto').innerHTML = 
        '<div class="row">' +
        '<div class="col-md-4">' +
        '<strong class="text-primary">Producto:</strong><br>' + 
        productoActualSeleccionado.nombre + '<br>' +
        '<small class="text-muted">C√≥digo: ' + productoActualSeleccionado.codigo + '</small>' +
        '</div>' +
        '<div class="col-md-4">' +
        '<strong class="text-primary">Categor√≠a:</strong><br>' + 
        productoActualSeleccionado.categoria +
        '</div>' +
        '<div class="col-md-4">' +
        '<strong class="text-primary">Stock Actual:</strong><br>' + 
        '<span class="badge bg-info fs-6">' + productoActualSeleccionado.stock_actual + ' unidades</span>' +
        '</div>' +
        '</div>';
    
    document.getElementById('productoElegido').style.display = 'block';
    
    // Configurar formulario
    document.getElementById('idProducto').value = productoActualSeleccionado.id;
    document.getElementById('formularioCompleto').style.display = 'block';
    
    // Enfocar en el campo cantidad
    setTimeout(function() {
        document.getElementById('inputCantidad').focus();
    }, 200);
    
    // Hacer scroll suave hacia el formulario
    document.getElementById('formularioCompleto').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// Funci√≥n de validaci√≥n antes de enviar
function validarDatos() {
    // Verificar que hay un producto seleccionado
    if (!productoActualSeleccionado) {
        alert('‚ùå Error: Debes seleccionar un producto primero');
        document.getElementById('txtBusqueda').focus();
        return false;
    }
    
    // Verificar cantidad
    var cantidad = document.getElementById('inputCantidad').value;
    if (!cantidad || cantidad <= 0) {
        alert('‚ùå Error: Debes ingresar una cantidad v√°lida mayor a 0');
        document.getElementById('inputCantidad').focus();
        return false;
    }
    
    // Verificar √°rea
    var area = document.getElementById('selectArea').value;
    if (!area) {
        alert('‚ùå Error: Debes seleccionar un √°rea de almacenamiento');
        document.getElementById('selectArea').focus();
        return false;
    }
    
    // Confirmaci√≥n final
    var areaTexto = document.getElementById('selectArea').options[document.getElementById('selectArea').selectedIndex].text;
    var mensaje = '¬øConfirmas agregar ' + cantidad + ' unidades de "' + productoActualSeleccionado.nombre + '"?\n\n';
    mensaje += '√Årea: ' + areaTexto;
    
    var precio = document.getElementById('inputPrecio').value;
    if (precio && precio > 0) {
        mensaje += '\nPrecio: $' + precio;
    }
    
    return confirm(mensaje);
}

// Funci√≥n para limpiar todo el formulario
function limpiarTodo() {
    document.getElementById('txtBusqueda').value = '';
    document.getElementById('resultadosBusqueda').style.display = 'none';
    document.getElementById('productoElegido').style.display = 'none';
    document.getElementById('formularioCompleto').style.display = 'none';
    
    // Resetear formulario
    document.querySelector('form').reset();
    document.getElementById('inputFecha').value = '{{ fecha_hoy }}';
    
    productoActualSeleccionado = null;
    document.getElementById('txtBusqueda').focus();
}

// Configurar eventos al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus en el campo de b√∫squeda
    document.getElementById('txtBusqueda').focus();
    
    // Buscar mientras se escribe
    document.getElementById('txtBusqueda').addEventListener('input', buscarProductos);
    
    // Buscar al presionar Enter
    document.getElementById('txtBusqueda').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            buscarProductos();
        }
    });
});
</script>
{% endblock %}