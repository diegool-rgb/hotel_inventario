{% extends 'base.html' %}

{% block title %}Agregar Stock{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-primary mb-1">Agregar Stock al Inventario</h2>
            <p class="text-muted mb-0">Revisa el producto seleccionado y registra la nueva compra.</p>
        </div>
        <a href="{% url 'inventario:productos' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Volver a productos
        </a>
    </div>

    {% if not producto_preseleccionado %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            No se encontró un producto seleccionado. Regresa al listado y elige uno para agregar stock.
        </div>
    {% else %}
        <div class="card mb-4 border-success">
            <div class="card-body">
                <h5 class="text-success mb-3"><i class="bi bi-check-circle me-2"></i>Producto seleccionado</h5>
                <div class="row gy-3">
                    <div class="col-md-4">
                        <div class="text-muted small">Producto</div>
                        <div class="fw-bold">{{ producto_preseleccionado.nombre }}</div>
                        <div class="small text-muted">Código: {{ producto_preseleccionado.codigo }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">Categoría</div>
                        <div class="fw-bold">{{ producto_preseleccionado.categoria.nombre }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">Stock actual</div>
                        <span class="badge bg-info fs-6">{{ producto_preseleccionado.stock_total|default:0 }} {{ producto_preseleccionado.unidad_medida }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="text-primary mb-4"><i class="bi bi-pencil-square me-2"></i>Registrar entrada</h5>
                <form method="post" onsubmit="return validarFormulario()">
                    {% csrf_token %}
                    <input type="hidden" name="producto_id" id="idProducto" value="{{ producto_preseleccionado.id }}">

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold text-primary"><i class="bi bi-plus-circle"></i> Cantidad *</label>
                            <input type="number" class="form-control form-control-lg" name="cantidad" id="inputCantidad" min="0.01" step="0.01" placeholder="Ejemplo: 10" required>
                            <small class="text-muted">¿Cuántas unidades agregaste?</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold text-primary"><i class="bi bi-geo-alt"></i> Área de almacenamiento *</label>
                            <div class="d-flex align-items-start gap-2">
                                <select class="form-select form-control-lg" name="area" id="selectArea" required>
                                    <option value="">Selecciona el área</option>
                                    {% for area in areas %}
                                        <option value="{{ area.id }}" {% if producto_preseleccionado.ultima_area and area.id == producto_preseleccionado.ultima_area.id %}selected{% endif %}>{{ area.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" onclick="openManageModal('area')">
                                    <i class="bi bi-tools"></i>
                                </button>
                            </div>
                            <small class="text-muted">¿Dónde guardaste el producto?</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold"><i class="bi bi-building"></i> Proveedor</label>
                            <div class="d-flex align-items-start gap-2">
                                <select class="form-select form-control-lg" name="proveedor" id="selectProveedor">
                                    <option value="">Sin proveedor específico</option>
                                    {% for proveedor in proveedores %}
                                        <option value="{{ proveedor.id }}" {% if producto_preseleccionado.ultimo_proveedor and proveedor.id == producto_preseleccionado.ultimo_proveedor.id %}selected{% endif %}>{{ proveedor.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" onclick="openManageModal('proveedor')">
                                    <i class="bi bi-tools"></i>
                                </button>
                            </div>
                            <small class="text-muted">Añade o selecciona proveedores sin salir.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="bi bi-cash"></i> Precio unitario</label>
                            <input type="number" class="form-control form-control-lg" name="precio" id="inputPrecio" min="0" step="0.01" placeholder="0.00" value="{% if producto_preseleccionado.ultimo_precio %}{{ producto_preseleccionado.ultimo_precio }}{% endif %}">
                            <small class="text-muted">Opcional.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="bi bi-calendar"></i> Fecha de compra</label>
                            <input type="date" class="form-control form-control-lg" name="fecha_compra" id="inputFecha" value="{{ fecha_hoy }}">
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary btn-lg" onclick="limpiarFormulario()">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Limpiar campos
                        </button>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle-fill me-1"></i>Agregar stock
                        </button>
                    </div>
                </form>
            </div>
        </div>
    {% endif %}
</div>

<script>
const productoSeleccionado = {% if producto_preseleccionado %}{
    id: {{ producto_preseleccionado.id }},
    nombre: "{{ producto_preseleccionado.nombre|escapejs }}"
}{% else %}null{% endif %};

function validarFormulario() {
    if (!productoSeleccionado) {
        alert('No se reconoció el producto. Vuelve atrás y selecciona uno.');
        return false;
    }
    const cantidad = parseFloat(document.getElementById('inputCantidad').value || '0');
    if (cantidad <= 0) {
        alert('Ingresa una cantidad válida mayor a 0.');
        document.getElementById('inputCantidad').focus();
        return false;
    }
    if (!document.getElementById('selectArea').value) {
        alert('Selecciona el área de almacenamiento.');
        document.getElementById('selectArea').focus();
        return false;
    }
    return confirm(`¿Confirmas agregar ${cantidad} unidades de "${productoSeleccionado.nombre}"?`);
}

function limpiarFormulario() {
    document.querySelector('form').reset();
    document.getElementById('inputFecha').value = '{{ fecha_hoy }}';
    document.getElementById('inputCantidad').focus();
}
</script>

{% include 'inventario/includes/manage_entities_modal.html' with modal_id='manageEntitiesModalSimple' proveedor_select_id='selectProveedor' area_select_id='selectArea' show_area_tab=True area_tipos=area_tipos %}
{% endblock %}
